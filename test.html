<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polling App WebSocket Test Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-700 mb-2">Polling App WebSocket Test Client</h1>
            <p class="text-gray-600">Test real-time updates for your polling application</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Connection Panel -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Connection Management</h2>

                <div class="flex items-center mb-4">
                    <div id="connectionStatus"
                        class="px-3 py-1 rounded-full text-sm font-medium mr-4 bg-red-100 text-red-800">Disconnected
                    </div>
                    <button id="connectBtn" onclick="connectWebSocket()"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2">Connect</button>
                    <button id="disconnectBtn" onclick="disconnectWebSocket()"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded mr-2"
                        disabled>Disconnect</button>
                    <button onclick="ping()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Ping</button>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">WebSocket URL</label>
                    <input type="text" id="wsUrl" value="ws://localhost:3000"
                        class="w-full px-3 py-2 border border-gray-300 rounded">
                </div>

                <div class="bg-gray-50 p-4 rounded">
                    <h3 class="font-medium text-gray-700 mb-2">Connection Info</h3>
                    <div class="text-sm text-gray-600">
                        <div>Clients Connected: <span id="clientCount">0</span></div>
                        <div>Poll Subscriptions: <span id="pollSubscriptionCount">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Subscription Panel -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Subscription Management</h2>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Poll ID</label>
                    <div class="flex">
                        <input type="text" id="pollId" placeholder="Enter Poll ID"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-l">
                        <button onclick="subscribeToPoll()"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-r">Subscribe</button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">User ID</label>
                    <div class="flex">
                        <input type="text" id="userId" placeholder="Enter User ID"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-l">
                        <button onclick="subscribeToUser()"
                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-r">Subscribe</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button onclick="unsubscribeFromPoll()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Unsubscribe from
                        Poll</button>
                    <button onclick="unsubscribeFromUser()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Unsubscribe from
                        User</button>
                </div>
            </div>
        </div>

        <!-- Message Log -->
        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Message Log</h2>
            <div id="messageLog" class="h-64 overflow-y-auto bg-gray-50 p-4 rounded border border-gray-200">
                <div class="text-gray-500 text-center py-8">No messages yet. Connect to start receiving messages.</div>
            </div>
            <div class="mt-4 flex">
                <input type="text" id="messageInput" placeholder="Type a message to send (JSON)"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l">
                <button onclick="sendCustomMessage()"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-r">Send</button>
            </div>
        </div>

        <!-- API Testing -->
        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">API Testing</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Create Test Poll</h3>
                    <div class="mb-2">
                        <input type="text" id="pollQuestion" placeholder="Poll question"
                            class="w-full px-3 py-2 border border-gray-300 rounded mb-2">
                        <input type="text" id="pollOptions" placeholder="Option1, Option2, Option3"
                            class="w-full px-3 py-2 border border-gray-300 rounded">
                    </div>
                    <button onclick="createTestPoll()"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full">Create Poll</button>
                </div>

                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Simulate Vote</h3>
                    <div class="mb-2">
                        <input type="text" id="votePollId" placeholder="Poll ID"
                            class="w-full px-3 py-2 border border-gray-300 rounded mb-2">
                        <input type="text" id="voteOptionId" placeholder="Option ID"
                            class="w-full px-3 py-2 border border-gray-300 rounded">
                    </div>
                    <button onclick="simulateVote()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full">Simulate Vote</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let token = null;
        let apiUrl = 'http://localhost:3000/api/';


        async function getToken() {
            if (token) return token;
            await fetch(`${apiUrl}users/login`,
                {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: "john.doe@example.com",
                        password: "securePassword123"
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status != 'success') {
                        logMessage('Failed to login: ' + JSON.stringify(data), 'error');
                        return;
                    }
                    token = data.data.token;

                })
                .catch(error => {
                    logMessage('Error casting vote: ' + error.message, 'error');
                });

            return token;
        }

        async function refreshToken() {
            token = null;
            await getToken();
        }
        async function testToken() {
            return await fetch(`${apiUrl}users/me`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + (await getToken())
                }
            }).
                then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        return true;
                    } else {
                        return false;
                    }
                })
                .catch(error => {
                    return false;
                });
        }


        // Update UI based on connection status
        function updateConnectionStatus(connected) {
            const statusElem = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            if (connected) {
                statusElem.textContent = 'Connected';
                statusElem.className = 'px-3 py-1 rounded-full text-sm font-medium mr-4 bg-green-100 text-green-800';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusElem.textContent = 'Disconnected';
                statusElem.className = 'px-3 py-1 rounded-full text-sm font-medium mr-4 bg-red-100 text-red-800';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // Connect to WebSocket
        function connectWebSocket() {
            const wsUrl = document.getElementById('wsUrl').value;
            

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    logMessage('Connected to WebSocket server', 'success');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;

                    // Request WebSocket stats
                    setTimeout(() => {
                        fetch(`${apiUrl}websocket-stats`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.data && data.data.totalClients !== undefined) {
                                    document.getElementById('clientCount').textContent = data.data.totalClients;
                                    document.getElementById('pollSubscriptionCount').textContent =
                                        data.data.pollSubscriptions ? data.data.pollSubscriptions.length : 0;
                                }
                            })
                            .catch(err => console.error('Error fetching stats:', err));
                    }, 1000);
                };

                ws.onmessage = function (event) {
                    logMessage('Received: ' + event.data, 'received');

                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'poll_update') {
                            logMessage(`Poll ${data.pollId} updated: ${JSON.stringify(data.data)}`, 'info');
                        } else if (data.type === 'user_update') {
                            logMessage(`User ${data.userId} update: ${JSON.stringify(data.data)}`, 'info');
                        }
                    } catch (e) {
                        // Not JSON, display as-is
                    }
                };

                ws.onclose = function () {
                    logMessage('Disconnected from WebSocket server', 'error');
                    updateConnectionStatus(false);

                    // Try to reconnect
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        logMessage(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`, 'warning');
                        setTimeout(connectWebSocket, 2000);
                    }
                };

                ws.onerror = function (error) {
                    logMessage('WebSocket error: ' + JSON.stringify(error), 'error');
                };

            } catch (error) {
                logMessage('Failed to connect: ' + error.message, 'error');
            }
        }

        // Disconnect from WebSocket
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            updateConnectionStatus(false);
        }

        // Send ping message
        function ping() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({ type: 'ping' });
                ws.send(message);
                logMessage('Sent: ' + message, 'sent');
            } else {
                logMessage('Not connected to WebSocket server', 'error');
            }
        }

        // Subscribe to poll updates
        function subscribeToPoll() {
            const pollId = document.getElementById('pollId').value.trim();
            if (!pollId) {
                alert('Please enter a Poll ID');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'subscribe_to_poll',
                    pollId: pollId
                });
                ws.send(message);
                logMessage('Sent: ' + message, 'sent');
            } else {
                logMessage('Not connected to WebSocket server', 'error');
            }
        }

        // Unsubscribe from poll updates
        function unsubscribeFromPoll() {
            const pollId = document.getElementById('pollId').value.trim();

            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'unsubscribe_from_poll',
                    pollId: pollId || ''
                });
                ws.send(message);
                logMessage('Sent: ' + message, 'sent');
            } else {
                logMessage('Not connected to WebSocket server', 'error');
            }
        }

        // Subscribe to user updates
        function subscribeToUser() {
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'subscribe_to_user',
                    userId: userId
                });
                ws.send(message);
                logMessage('Sent: ' + message, 'sent');
            } else {
                logMessage('Not connected to WebSocket server', 'error');
            }
        }

        // Unsubscribe from user updates
        function unsubscribeFromUser() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'unsubscribe_from_user'
                });
                ws.send(message);
                logMessage('Sent: ' + message, 'sent');
            } else {
                logMessage('Not connected to WebSocket server', 'error');
            }
        }

        // Send custom message
        function sendCustomMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    // Try to parse as JSON to validate
                    JSON.parse(message);
                    ws.send(message);
                    logMessage('Sent: ' + message, 'sent');
                    messageInput.value = '';
                } catch (e) {
                    alert('Invalid JSON format: ' + e.message);
                }
            } else {
                logMessage('Not connected to WebSocket server', 'error');
            }
        }

        // Create a test poll
        async function createTestPoll() {
            const question = document.getElementById('pollQuestion').value.trim();
            const options = document.getElementById('pollOptions').value.trim();

            if (!question || !options) {
                alert('Please enter both question and options');
                return;
            }

            const optionsArray = options.split(',').map(opt => ({ text: opt.trim() }));
            if(!(await testToken())) await refreshToken();
            fetch(`${apiUrl}polls`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    question: question,
                    options: optionsArray,
                    isPublished: true
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        logMessage(`Poll created: ${data.data.poll.id}`, 'success');
                        document.getElementById('pollId').value = data.data.poll.id;

                        // Add option IDs to the simulate vote section
                        if (data.data.poll.options && data.data.poll.options.length > 0) {
                            document.getElementById('votePollId').value = data.data.poll.id;
                            document.getElementById('voteOptionId').value = data.data.poll.options[0].id;
                        }
                    } else {
                        logMessage('Failed to create poll: ' + JSON.stringify(data), 'error');
                    }
                })
                .catch(error => {
                    logMessage('Error creating poll: ' + error.message, 'error');
                });
        }
        // Simulate a vote
        async function simulateVote() {
            const pollId = document.getElementById('votePollId').value.trim();
            const optionId = document.getElementById('voteOptionId').value.trim();

            if (!pollId || !optionId) {
                alert('Please enter both Poll ID and Option ID');
                return;
            }
if(!(await testToken())) await refreshToken();
            fetch(`${apiUrl}polls/${pollId}/vote/${optionId}`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        logMessage(`Vote cast: ${JSON.stringify(data.data)}`, 'success');
                    } else {
                        logMessage('Failed to cast vote: ' + JSON.stringify(data), 'error');
                    }
                })
                .catch(error => {
                    logMessage('Error casting vote: ' + error.message, 'error');
                });
        }

        // Log messages to the message log
        function logMessage(message, type = 'info') {
            const messageLog = document.getElementById('messageLog');

            // Clear placeholder if it exists
            if (messageLog.innerHTML.includes('No messages yet')) {
                messageLog.innerHTML = '';
            }

            const messageElem = document.createElement('div');
            messageElem.className = 'mb-2 p-2 rounded break-all';

            // Add styling based on message type
            if (type === 'success') {
                messageElem.className += ' bg-green-100 text-green-800 border-l-4 border-green-500';
            } else if (type === 'error') {
                messageElem.className += ' bg-red-100 text-red-800 border-l-4 border-red-500';
            } else if (type === 'warning') {
                messageElem.className += ' bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500';
            } else if (type === 'sent') {
                messageElem.className += ' bg-blue-100 text-blue-800 border-l-4 border-blue-500';
            } else if (type === 'received') {
                messageElem.className += ' bg-purple-100 text-purple-800 border-l-4 border-purple-500';
            } else {
                messageElem.className += ' bg-gray-100 text-gray-800 border-l-4 border-gray-500';
            }

            const timestamp = new Date().toLocaleTimeString();
            messageElem.innerHTML = `<span class="text-gray-500 text-xs">[${timestamp}]</span> ${message}`;

            messageLog.appendChild(messageElem);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Try to auto-connect if the URL is localhost
            const wsUrl = document.getElementById('wsUrl').value;
            if (wsUrl.includes('localhost') || wsUrl.includes('127.0.0.1')) {
                setTimeout(connectWebSocket, 500);
            }

            // Add example messages for guidance
            logMessage('Welcome to the WebSocket Test Client!', 'info');
            logMessage('1. Click Connect to establish a WebSocket connection', 'info');
            logMessage('2. Subscribe to a Poll or User to receive real-time updates', 'info');
            logMessage('3. Use the API section to create test data', 'info');
        });
    </script>
</body>

</html>